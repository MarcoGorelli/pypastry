#!/usr/bin/env python
import glob
import pkgutil
import re
import sys
from importlib import import_module

import pandas as pd
import tomlkit

sys.path.append('.')

PREDICTORS_GLOB = 'predictors/*.py'
PREDICTORS_RE = re.compile(r'predictors/(.+)\.py')


def run(config):
    data_sources = {}
    for data_source in config['data_source']:
        url = data_source['url']
        data = pd.read_csv(url)
        data_sources[data_source['name']] = data

    dataset = data_sources[config['dataset']['data_source']]
    predictors = get_predictors()
    print(predictors)



def get_predictors():
    predictors = []
    # for filename in glob.glob(PREDICTORS_GLOB):
    #     matches = PREDICTORS_RE.match(filename)
    #     modname = 'predictors.' + matches.group(1)

    for _, module_name, _ in pkgutil.walk_packages(['.']):
        # print("Found submodule %s (is a package: %s)" % (modname, ispkg))
        module = import_module(module_name)
        try:
            predictor = module.get_predictor()
        except AttributeError:
            continue
        predictors.append(predictor)
    return predictors



if __name__ == "__main__":
    with open('config.toml') as toml_file:
        config = tomlkit.loads(toml_file.read())
        run(config)
