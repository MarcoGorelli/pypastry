#!/usr/bin/env python
import glob
import pkgutil
import re
import sys
from importlib import import_module

import pandas as pd
import tomlkit
from sklearn.model_selection import cross_validate
from tomlkit.toml_document import TOMLDocument

sys.path.append('.')

PREDICTORS_GLOB = 'predictors/*.py'
PREDICTORS_RE = re.compile(r'predictors/(.+)\.py')


def run(config: TOMLDocument):
    dataset = get_dataset(config)
    print(dataset)
    label_column = config['dataset']['label_column']
    X = dataset.drop(columns=[label_column])
    y = dataset[label_column]
    predictors = get_predictors()
    for predictor in predictors:
        scores = cross_validate(predictor, X, y)
        print(predictor, scores)

def get_dataset(config: TOMLDocument) -> pd.DataFrame:
    data_sources = {}
    for data_source in config['data_source']:
        url = data_source['url']
        data = pd.read_csv(url)
        data_sources[data_source['name']] = data
    return data_sources[config['dataset']['data_source']]


def get_predictors():
    predictors = []

    for _, module_name, _ in pkgutil.walk_packages(['.']):
        # print("Found submodule %s (is a package: %s)" % (modname, ispkg))
        module = import_module(module_name)
        try:
            predictor = module.get_predictor()
        except AttributeError:
            continue
        predictors.append(predictor)
    return predictors


if __name__ == "__main__":
    with open('config.toml') as toml_file:
        toml_config = tomlkit.loads(toml_file.read())
        run(toml_config)
